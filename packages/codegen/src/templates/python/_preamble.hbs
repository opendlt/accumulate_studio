#!/usr/bin/env python3
"""
{{flow.name}}
{{repeatChar "=" flow.name.length}}

Generated by Accumulate Studio
Network: {{network}}
"""

import time

from accumulate_client import Accumulate{{#if hasTransactions}}, NetworkStatusOptions{{/if}}
from accumulate_client.convenience import TxBody, SmartSigner
{{#if hasKeyGen}}
from accumulate_client.crypto.ed25519 import Ed25519KeyPair
import hashlib
{{/if}}
{{#if hasFaucet}}
import requests as _requests_lib
{{/if}}

# Network endpoints
NETWORK_ENDPOINT = "https://{{network}}.accumulatenetwork.io"
# For local DevNet testing, uncomment:
# NETWORK_ENDPOINT = "http://127.0.0.1:26660"

{{#if hasFaucet}}

def fund_account(client, account_url, faucet_requests=1):
    """Fund an account using the testnet faucet with retry logic."""
    v2_endpoint = client.v2.endpoint
    print(f"Requesting funds from faucet ({faucet_requests} times)...")
    for i in range(faucet_requests):
        try:
            response = _requests_lib.post(
                v2_endpoint,
                json={
                    "jsonrpc": "2.0",
                    "method": "faucet",
                    "params": {"url": account_url},
                    "id": i + 1,
                },
                timeout=30,
            )
            result = response.json()
            txid = result.get("result", {}).get("txid", "submitted")
            print(f"  Faucet {i+1}/{faucet_requests}: {str(txid)[:40]}...")
            time.sleep(2)
        except Exception as e:
            print(f"  Faucet {i+1}/{faucet_requests} failed: {e}")

{{/if}}
{{#if hasWait}}

def poll_for_balance(client, account_url, min_balance=1, max_attempts=30):
    """Poll until account balance meets minimum threshold."""
    for i in range(max_attempts):
        try:
            result = client.v3.query(account_url)
            balance = result.get("account", {}).get("balance")
            if balance is not None:
                balance_int = int(balance) if isinstance(balance, (int, str)) else 0
                if balance_int > 0 and balance_int >= min_balance:
                    return balance_int
            print(f"  Waiting for balance... (attempt {i+1}/{max_attempts})")
        except Exception:
            pass
        time.sleep(2)
    return 0


def poll_for_credits(client, account_url, min_credits=1, max_attempts=30):
    """Poll until account credit balance meets minimum threshold."""
    for i in range(max_attempts):
        try:
            result = client.v3.query(account_url)
            credits = result.get("account", {}).get("creditBalance", 0)
            if int(credits) > 0 and int(credits) >= min_credits:
                return int(credits)
            print(f"  Waiting for credits... (attempt {i+1}/{max_attempts})")
        except Exception:
            pass
        time.sleep(2)
    return 0

{{/if}}

def main():
    """
    {{flow.name}}
{{#if flow.description}}
    {{flow.description}}
{{/if}}
    Generated by Accumulate Studio
    """

    # Connect to the network
    client = Accumulate(NETWORK_ENDPOINT)
    tx_ids = []
{{#if hasFlowVars}}

    # Flow variables (customize these for your use case)
{{#each flowVarDefs}}
    {{this.pythonName}} = {{this.defaultValue}}  # {{this.description}}
{{/each}}
{{/if}}

    try:
