/// Multi-Signature Setup
/// Generated by Accumulate Studio
/// Network: devnet

import 'dart:async';
import 'dart:io';
import 'dart:typed_data';
import 'package:crypto/crypto.dart';
import 'package:opendlt_accumulate/opendlt_accumulate.dart';

const String defaultV2 = 'https://kermit.accumulatenetwork.io/v2';
const String defaultV3 = 'https://kermit.accumulatenetwork.io/v3';

String toHexString(List<int> bytes) {
  return bytes.map((b) => b.toRadixString(16).padLeft(2, '0')).join();
}

Future<void> main() async {
  final v2 = Platform.environment['ACCUMULATE_V2_URL'] ?? defaultV2;
  final v3 = Platform.environment['ACCUMULATE_V3_URL'] ?? defaultV3;
  final client = Accumulate.custom(v2Endpoint: v2, v3Endpoint: v3);
  final txIds = <MapEntry<String, String>>[];
  try {


    // =========================================================
    // CreateKeyBook (Action: CreateKeyBook)
    // =========================================================
    final createKeyBookSigner = SmartSigner(
      client: client.v3,
      keypair: createKeyBookKey,
      signerUrl: createKeyBookLid.toString(),
    );
    final createKeyBookResult = await createKeyBookSigner.signSubmitAndWait(
      principal: adi_url,
      body: TxBody.createKeyBook(
        url: '{adi_url}/{key_book_name}',
        publicKeyHash: signer_1_public_key_hash,
      ),
      memo: 'Create key book',
      maxAttempts: 30,
    );
    if (createKeyBookResult.success) {
      print('CreateKeyBook SUCCESS - TxID: ${createKeyBookResult.txid}');
      if (createKeyBookResult.txid != null) {
        txIds.add(MapEntry('CreateKeyBook', createKeyBookResult.txid!));
      }
    } else {
      print('CreateKeyBook FAILED: ${createKeyBookResult.error}');
    }


    // =========================================================
    // CreateKeyPage (Action: CreateKeyPage)
    // =========================================================
    final createKeyPageSigner = SmartSigner(
      client: client.v3,
      keypair: createKeyPageKey,
      signerUrl: createKeyPageLid.toString(),
    );
    final createKeyPageResult = await createKeyPageSigner.signSubmitAndWait(
      principal: '{adi_url}/{key_book_name}',
      body: TxBody.createKeyPage(
        keys: [
          KeySpecParams.fromHex('signer_1_public_key_hash'),
        ],
      ),
      memo: 'Create key page',
      maxAttempts: 30,
    );
    if (createKeyPageResult.success) {
      print('CreateKeyPage SUCCESS - TxID: ${createKeyPageResult.txid}');
      if (createKeyPageResult.txid != null) {
        txIds.add(MapEntry('CreateKeyPage', createKeyPageResult.txid!));
      }
    } else {
      print('CreateKeyPage FAILED: ${createKeyPageResult.error}');
    }


    // =========================================================
    // UpdateKeyPage (Action: UpdateKeyPage)
    // =========================================================
    final addSigner_2Signer = SmartSigner(
      client: client.v3,
      keypair: addSigner_2Key,
      signerUrl: addSigner_2Lid.toString(),
    );
    final addSigner_2RawOps = [{"type":"add","key":"signer_2_public_key_hash"}] as List;
    final addSigner_2Result = await addSigner_2Signer.signSubmitAndWait(
      principal: '{adi_url}/{key_book_name}/1',
      body: TxBody.updateKeyPage(
        operations: addSigner_2RawOps
            .map((op) => KeyPageOperation.fromJson(Map<String, dynamic>.from(op)))
            .toList(),
      ),
      memo: 'Update key page',
      maxAttempts: 30,
    );
    if (addSigner_2Result.success) {
      print('UpdateKeyPage SUCCESS - TxID: ${addSigner_2Result.txid}');
      if (addSigner_2Result.txid != null) {
        txIds.add(MapEntry('UpdateKeyPage', addSigner_2Result.txid!));
      }
    } else {
      print('UpdateKeyPage FAILED: ${addSigner_2Result.error}');
    }


    // =========================================================
    // UpdateKeyPage (Action: UpdateKeyPage)
    // =========================================================
    final addSigner_3Signer = SmartSigner(
      client: client.v3,
      keypair: addSigner_3Key,
      signerUrl: addSigner_3Lid.toString(),
    );
    final addSigner_3RawOps = [{"type":"add","key":"signer_3_public_key_hash"}] as List;
    final addSigner_3Result = await addSigner_3Signer.signSubmitAndWait(
      principal: '{adi_url}/{key_book_name}/1',
      body: TxBody.updateKeyPage(
        operations: addSigner_3RawOps
            .map((op) => KeyPageOperation.fromJson(Map<String, dynamic>.from(op)))
            .toList(),
      ),
      memo: 'Update key page',
      maxAttempts: 30,
    );
    if (addSigner_3Result.success) {
      print('UpdateKeyPage SUCCESS - TxID: ${addSigner_3Result.txid}');
      if (addSigner_3Result.txid != null) {
        txIds.add(MapEntry('UpdateKeyPage', addSigner_3Result.txid!));
      }
    } else {
      print('UpdateKeyPage FAILED: ${addSigner_3Result.error}');
    }


    // =========================================================
    // UpdateKeyPage (Action: UpdateKeyPage)
    // =========================================================
    final setThresholdSigner = SmartSigner(
      client: client.v3,
      keypair: setThresholdKey,
      signerUrl: setThresholdLid.toString(),
    );
    final setThresholdRawOps = [{"type":"setThreshold","threshold":"threshold"}] as List;
    final setThresholdResult = await setThresholdSigner.signSubmitAndWait(
      principal: '{adi_url}/{key_book_name}/1',
      body: TxBody.updateKeyPage(
        operations: setThresholdRawOps
            .map((op) => KeyPageOperation.fromJson(Map<String, dynamic>.from(op)))
            .toList(),
      ),
      memo: 'Update key page',
      maxAttempts: 30,
    );
    if (setThresholdResult.success) {
      print('UpdateKeyPage SUCCESS - TxID: ${setThresholdResult.txid}');
      if (setThresholdResult.txid != null) {
        txIds.add(MapEntry('UpdateKeyPage', setThresholdResult.txid!));
      }
    } else {
      print('UpdateKeyPage FAILED: ${setThresholdResult.error}');
    }


    print('\n========== Transaction Summary ==========');
    for (final entry in txIds) {
      print('  ${entry.key}: ${entry.value}');
    }
    print('Flow completed successfully!');
  } finally {
    client.close();
  }
}
