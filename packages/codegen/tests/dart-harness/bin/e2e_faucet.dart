/// Faucet E2E
/// Generated by Accumulate Studio
/// Network: kermit

import 'dart:async';
import 'dart:io';
import 'dart:typed_data';
import 'package:crypto/crypto.dart';
import 'package:opendlt_accumulate/opendlt_accumulate.dart';

const String defaultV2 = 'https://kermit.accumulatenetwork.io/v2';
const String defaultV3 = 'https://kermit.accumulatenetwork.io/v3';

String toHexString(List<int> bytes) {
  return bytes.map((b) => b.toRadixString(16).padLeft(2, '0')).join();
}

Future<void> main() async {
  final v2 = Platform.environment['ACCUMULATE_V2_URL'] ?? defaultV2;
  final v3 = Platform.environment['ACCUMULATE_V3_URL'] ?? defaultV3;
  final client = Accumulate.custom(v2Endpoint: v2, v3Endpoint: v3);
  final txIds = <MapEntry<String, String>>[];
  try {


    // =========================================================
    // GenerateKeys (GenerateKeys)
    // =========================================================
    final generatekeysKp = await Ed25519KeyPair.generate();
    final generatekeysKey = UnifiedKeyPair.fromEd25519(generatekeysKp);
    final generatekeysLid = await generatekeysKp.deriveLiteIdentityUrl();
    final generatekeysLta = await generatekeysKp.deriveLiteTokenAccountUrl();
    final generatekeysPubKey = await generatekeysKp.publicKeyBytes();
    final generatekeysPubHash = toHexString(sha256.convert(generatekeysPubKey).bytes);
    print('Generated keypair:');
    print('  Lite Identity: ${generatekeysLid}');
    print('  Lite Token Account: ${generatekeysLta}');
    print('  Public Key Hash: ${generatekeysPubHash}');


    // =========================================================
    // Faucet (Faucet)
    // =========================================================
    print('Requesting tokens from faucet...');
    for (var i = 0; i < 1; i++) {
      try {
        final resp = await client.v2.faucet({
          'type': 'acmeFaucet',
          'url': generatekeysLta.toString(),
        });
        print('  Faucet ${i + 1}/1: ${resp["txid"]}');
      } catch (e) {
        print('  Faucet ${i + 1}/1 failed: $e');
      }
      await Future.delayed(Duration(seconds: 2));
    }
    print('Faucet request completed');


    print('\n========== Transaction Summary ==========');
    for (final entry in txIds) {
      print('  ${entry.key}: ${entry.value}');
    }
    print('Flow completed successfully!');
  } finally {
    client.close();
  }
}
