/// Token Transfer
/// Generated by Accumulate Studio
/// Network: devnet

import 'dart:async';
import 'dart:io';
import 'dart:typed_data';
import 'package:crypto/crypto.dart';
import 'package:opendlt_accumulate/opendlt_accumulate.dart';

const String defaultV2 = 'https://kermit.accumulatenetwork.io/v2';
const String defaultV3 = 'https://kermit.accumulatenetwork.io/v3';

String toHexString(List<int> bytes) {
  return bytes.map((b) => b.toRadixString(16).padLeft(2, '0')).join();
}

Future<void> main() async {
  final v2 = Platform.environment['ACCUMULATE_V2_URL'] ?? defaultV2;
  final v3 = Platform.environment['ACCUMULATE_V3_URL'] ?? defaultV3;
  final client = Accumulate.custom(v2Endpoint: v2, v3Endpoint: v3);
  final txIds = <MapEntry<String, String>>[];
  try {


    // =========================================================
    // CreateTokenAccount (Action: CreateTokenAccount)
    // =========================================================
    final createSenderAccountSigner = SmartSigner(
      client: client.v3,
      keypair: createSenderAccountKey,
      signerUrl: createSenderAccountLid.toString(),
    );
    final createSenderAccountResult = await createSenderAccountSigner.signSubmitAndWait(
      principal: adi_url,
      body: TxBody.createTokenAccount(
        url: '{adi_url}/{sender_account_name}',
        tokenUrl: 'acc://ACME',
      ),
      memo: 'Create token account',
      maxAttempts: 30,
    );
    if (createSenderAccountResult.success) {
      print('CreateTokenAccount SUCCESS - TxID: ${createSenderAccountResult.txid}');
      if (createSenderAccountResult.txid != null) {
        txIds.add(MapEntry('CreateTokenAccount', createSenderAccountResult.txid!));
      }
    } else {
      print('CreateTokenAccount FAILED: ${createSenderAccountResult.error}');
    }


    // =========================================================
    // CreateTokenAccount (Action: CreateTokenAccount)
    // =========================================================
    final createReceiverAccountSigner = SmartSigner(
      client: client.v3,
      keypair: createReceiverAccountKey,
      signerUrl: createReceiverAccountLid.toString(),
    );
    final createReceiverAccountResult = await createReceiverAccountSigner.signSubmitAndWait(
      principal: adi_url,
      body: TxBody.createTokenAccount(
        url: '{adi_url}/{receiver_account_name}',
        tokenUrl: 'acc://ACME',
      ),
      memo: 'Create token account',
      maxAttempts: 30,
    );
    if (createReceiverAccountResult.success) {
      print('CreateTokenAccount SUCCESS - TxID: ${createReceiverAccountResult.txid}');
      if (createReceiverAccountResult.txid != null) {
        txIds.add(MapEntry('CreateTokenAccount', createReceiverAccountResult.txid!));
      }
    } else {
      print('CreateTokenAccount FAILED: ${createReceiverAccountResult.error}');
    }


    // =========================================================
    // QueryAccount (QueryAccount)
    // =========================================================
    final querySenderResult = await client.v3.rawCall('query', {
      'scope': '{adi_url}/{sender_account_name}',
      'query': {'queryType': 'default'},
    });
    print('Account state: ${querySenderResult}');


    // =========================================================
    // SendTokens (Action: SendTokens)
    // =========================================================
    final sendTokensSigner = SmartSigner(
      client: client.v3,
      keypair: sendTokensKey,
      signerUrl: sendTokensLid.toString(),
    );
    final sendTokensResult = await sendTokensSigner.signSubmitAndWait(
      principal: '{adi_url}/{sender_account_name}',
      body: TxBody.sendTokensSingle(
        toUrl: '{adi_url}/{receiver_account_name}',
        amount: 'transfer_amount',
      ),
      memo: 'Send tokens',
      maxAttempts: 30,
    );
    if (sendTokensResult.success) {
      print('SendTokens SUCCESS - TxID: ${sendTokensResult.txid}');
      if (sendTokensResult.txid != null) {
        txIds.add(MapEntry('SendTokens', sendTokensResult.txid!));
      }
    } else {
      print('SendTokens FAILED: ${sendTokensResult.error}');
    }


    print('\n========== Transaction Summary ==========');
    for (final entry in txIds) {
      print('  ${entry.key}: ${entry.value}');
    }
    print('Flow completed successfully!');
  } finally {
    client.close();
  }
}
