//! Token Transfer
//! ==============
//!
//! Generated by Accumulate Studio
//! Network: devnet

use accumulate_client::{
    AccumulateClient, AccOptions, SmartSigner, TxBody,
    derive_lite_identity_url, derive_lite_token_account_url,
};
use sha2::{Digest, Sha256};
use url::Url;
use serde_json::{json, Value};

const NETWORK_V2: &str = "https://kermit.accumulatenetwork.io/v2";
const NETWORK_V3: &str = "https://kermit.accumulatenetwork.io/v3";

fn sha256_hash(data: &[u8]) -> String {
    let mut hasher = Sha256::new();
    hasher.update(data);
    hex::encode(hasher.finalize())
}

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    //
    // Token Transfer
    // Demonstrates how to send ACME tokens between accounts. Creates a sender token account and a receiver token account under an ADI, then performs a token transfer. Requires an existing ADI with credits.

    // Generated by Accumulate Studio
    //

    // Connect to network (override with env vars for testing)
    let v2 = std::env::var("ACCUMULATE_V2_URL").unwrap_or_else(|_| NETWORK_V2.to_string());
    let v3 = std::env::var("ACCUMULATE_V3_URL").unwrap_or_else(|_| NETWORK_V3.to_string());
    let client = AccumulateClient::new_with_options(
        Url::parse(&v2)?, Url::parse(&v3)?, AccOptions::default()
    ).await?;

    let mut tx_ids: Vec<(&str, String)> = Vec::new();


    // =========================================================
    // CreateTokenAccount (Action: CreateTokenAccount)
    // =========================================================
    let mut create_sender_account_signer = SmartSigner::new(&client, create_sender_account_signer.clone(), &create_sender_account_lid);
    let create_sender_account_result = create_sender_account_signer.sign_submit_and_wait(
        "adi_url",
        &TxBody::create_token_account("{adi_url}/{sender_account_name}", "acc://ACME"),
        Some("Create token account"),
        30,
    ).await;
    if create_sender_account_result.success {
        println!("CreateTokenAccount SUCCESS - TxID: {:?}", create_sender_account_result.txid);
        if let Some(ref txid) = create_sender_account_result.txid {
            tx_ids.push(("CreateTokenAccount", txid.clone()));
        }
    } else {
        println!("CreateTokenAccount FAILED: {:?}", create_sender_account_result.error);
    }

    // =========================================================
    // CreateTokenAccount (Action: CreateTokenAccount)
    // =========================================================
    let mut create_receiver_account_signer = SmartSigner::new(&client, create_receiver_account_signer.clone(), &create_receiver_account_lid);
    let create_receiver_account_result = create_receiver_account_signer.sign_submit_and_wait(
        "adi_url",
        &TxBody::create_token_account("{adi_url}/{receiver_account_name}", "acc://ACME"),
        Some("Create token account"),
        30,
    ).await;
    if create_receiver_account_result.success {
        println!("CreateTokenAccount SUCCESS - TxID: {:?}", create_receiver_account_result.txid);
        if let Some(ref txid) = create_receiver_account_result.txid {
            tx_ids.push(("CreateTokenAccount", txid.clone()));
        }
    } else {
        println!("CreateTokenAccount FAILED: {:?}", create_receiver_account_result.error);
    }

    // =========================================================
    // QueryAccount (Action: QueryAccount)
    // =========================================================
    let query_sender_params = json!({ "scope": "{adi_url}/{sender_account_name}", "query": { "queryType": "default" } });
    let query_sender_result: Value = client.v3_client.call_v3("query", query_sender_params).await?;
    println!("Account state: {:?}", query_sender_result);

    // =========================================================
    // SendTokens (Action: SendTokens)
    // =========================================================
    let mut send_tokens_signer = SmartSigner::new(&client, send_tokens_signer.clone(), &send_tokens_lid);
    let send_tokens_result = send_tokens_signer.sign_submit_and_wait(
        "{adi_url}/{sender_account_name}",
        &TxBody::send_tokens_single("{adi_url}/{receiver_account_name}", "transfer_amount"),
        Some("Send tokens"),
        30,
    ).await;
    if send_tokens_result.success {
        println!("SendTokens SUCCESS - TxID: {:?}", send_tokens_result.txid);
        if let Some(ref txid) = send_tokens_result.txid {
            tx_ids.push(("SendTokens", txid.clone()));
        }
    } else {
        println!("SendTokens FAILED: {:?}", send_tokens_result.error);
    }

    // =========================================================
    // Transaction Summary
    // =========================================================
    println!("\n========== Transaction Summary ==========");
    for (label, txid) in &tx_ids {
        println!("  {}: {}", label, txid);
    }
    println!("Flow completed successfully!");
    Ok(())
}
