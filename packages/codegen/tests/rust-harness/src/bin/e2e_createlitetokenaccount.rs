//! CreateLiteTokenAccount E2E
//! ==========================
//!
//! Generated by Accumulate Studio
//! Network: kermit

use accumulate_client::{
    AccumulateClient, AccOptions, SmartSigner, TxBody,
    derive_lite_identity_url, derive_lite_token_account_url,
};
use sha2::{Digest, Sha256};
use url::Url;
use serde_json::{json, Value};

const NETWORK_V2: &str = "https://kermit.accumulatenetwork.io/v2";
const NETWORK_V3: &str = "https://kermit.accumulatenetwork.io/v3";

fn sha256_hash(data: &[u8]) -> String {
    let mut hasher = Sha256::new();
    hasher.update(data);
    hex::encode(hasher.finalize())
}

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    //
    // CreateLiteTokenAccount E2E
    // E2E test for CreateLiteTokenAccount
    // Generated by Accumulate Studio
    //

    // Connect to network (override with env vars for testing)
    let v2 = std::env::var("ACCUMULATE_V2_URL").unwrap_or_else(|_| NETWORK_V2.to_string());
    let v3 = std::env::var("ACCUMULATE_V3_URL").unwrap_or_else(|_| NETWORK_V3.to_string());
    let client = AccumulateClient::new_with_options(
        Url::parse(&v2)?, Url::parse(&v3)?, AccOptions::default()
    ).await?;

    let mut tx_ids: Vec<(&str, String)> = Vec::new();


    // =========================================================
    // GenerateKeys (Action: GenerateKeys)
    // =========================================================
    let generatekeys_signer = AccumulateClient::generate_keypair();
    let generatekeys_pub_key = generatekeys_signer.verifying_key().to_bytes();
    let generatekeys_pub_hash = sha256_hash(&generatekeys_pub_key);
    let generatekeys_lid = derive_lite_identity_url(&generatekeys_pub_key);
    let generatekeys_lta = derive_lite_token_account_url(&generatekeys_pub_key);
    println!("Generated keypair:");
    println!("  Lite Identity: {}", generatekeys_lid);
    println!("  Lite Token Account: {}", generatekeys_lta);
    println!("  Public Key Hash: {}", &generatekeys_pub_hash[..32]);

    // CreateLiteTokenAccount
    // Create lite token account (implicit from keypair)
    // Lite token accounts are automatically derived from the public key

    // =========================================================
    // Transaction Summary
    // =========================================================
    println!("\n========== Transaction Summary ==========");
    for (label, txid) in &tx_ids {
        println!("  {}: {}", label, txid);
    }
    println!("Flow completed successfully!");
    Ok(())
}
