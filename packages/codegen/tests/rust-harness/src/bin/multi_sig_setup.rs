//! Multi-Signature Setup
//! =====================
//!
//! Generated by Accumulate Studio
//! Network: devnet

use accumulate_client::{
    AccumulateClient, AccOptions, SmartSigner, TxBody,
    derive_lite_identity_url, derive_lite_token_account_url,
};
use sha2::{Digest, Sha256};
use url::Url;
use serde_json::{json, Value};

const NETWORK_V2: &str = "https://kermit.accumulatenetwork.io/v2";
const NETWORK_V3: &str = "https://kermit.accumulatenetwork.io/v3";

fn sha256_hash(data: &[u8]) -> String {
    let mut hasher = Sha256::new();
    hasher.update(data);
    hex::encode(hasher.finalize())
}

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    //
    // Multi-Signature Setup
    // Advanced security configuration for ADIs. Sets up a multi-signature scheme with multiple key pages and signature thresholds. Essential for enterprise and high-security use cases.

    // Generated by Accumulate Studio
    //

    // Connect to network (override with env vars for testing)
    let v2 = std::env::var("ACCUMULATE_V2_URL").unwrap_or_else(|_| NETWORK_V2.to_string());
    let v3 = std::env::var("ACCUMULATE_V3_URL").unwrap_or_else(|_| NETWORK_V3.to_string());
    let client = AccumulateClient::new_with_options(
        Url::parse(&v2)?, Url::parse(&v3)?, AccOptions::default()
    ).await?;

    let mut tx_ids: Vec<(&str, String)> = Vec::new();


    // =========================================================
    // CreateKeyBook (Action: CreateKeyBook)
    // =========================================================
    let mut create_key_book_signer = SmartSigner::new(&client, create_key_book_signer.clone(), &create_key_book_lid);
    let create_key_book_result = create_key_book_signer.sign_submit_and_wait(
        "adi_url",
        &TxBody::create_key_book("{adi_url}/{key_book_name}", "signer_1_public_key_hash"),
        Some("Create key book"),
        30,
    ).await;
    if create_key_book_result.success {
        println!("CreateKeyBook SUCCESS - TxID: {:?}", create_key_book_result.txid);
        if let Some(ref txid) = create_key_book_result.txid {
            tx_ids.push(("CreateKeyBook", txid.clone()));
        }
    } else {
        println!("CreateKeyBook FAILED: {:?}", create_key_book_result.error);
    }

    // =========================================================
    // CreateKeyPage (Action: CreateKeyPage)
    // =========================================================
    let mut create_key_page_signer = SmartSigner::new(&client, create_key_page_signer.clone(), &create_key_page_lid);
    let create_key_page_key_0 = hex::decode("signer_1_public_key_hash").unwrap_or_default();
    let create_key_page_key_refs: Vec<&[u8]> = vec![
        &create_key_page_key_0,
    ];
    let create_key_page_result = create_key_page_signer.sign_submit_and_wait(
        "{adi_url}/{key_book_name}",
        &TxBody::create_key_page(&create_key_page_key_refs),
        Some("Create key page"),
        30,
    ).await;
    if create_key_page_result.success {
        println!("CreateKeyPage SUCCESS - TxID: {:?}", create_key_page_result.txid);
        if let Some(ref txid) = create_key_page_result.txid {
            tx_ids.push(("CreateKeyPage", txid.clone()));
        }
    } else {
        println!("CreateKeyPage FAILED: {:?}", create_key_page_result.error);
    }

    // =========================================================
    // UpdateKeyPage (Action: UpdateKeyPage)
    // =========================================================
    let mut add_signer_2_signer = SmartSigner::new(&client, add_signer_2_signer.clone(), &add_signer_2_lid);
    let add_signer_2_result = add_signer_2_signer.sign_submit_and_wait(
        "{adi_url}/{key_book_name}/1",
        &TxBody::update_key_page(&json!([{"type":"add","key":"signer_2_public_key_hash"}])),
        Some("Update key page"),
        30,
    ).await;
    if add_signer_2_result.success {
        println!("UpdateKeyPage SUCCESS - TxID: {:?}", add_signer_2_result.txid);
        if let Some(ref txid) = add_signer_2_result.txid {
            tx_ids.push(("UpdateKeyPage", txid.clone()));
        }
    } else {
        println!("UpdateKeyPage FAILED: {:?}", add_signer_2_result.error);
    }

    // =========================================================
    // UpdateKeyPage (Action: UpdateKeyPage)
    // =========================================================
    let mut add_signer_3_signer = SmartSigner::new(&client, add_signer_3_signer.clone(), &add_signer_3_lid);
    let add_signer_3_result = add_signer_3_signer.sign_submit_and_wait(
        "{adi_url}/{key_book_name}/1",
        &TxBody::update_key_page(&json!([{"type":"add","key":"signer_3_public_key_hash"}])),
        Some("Update key page"),
        30,
    ).await;
    if add_signer_3_result.success {
        println!("UpdateKeyPage SUCCESS - TxID: {:?}", add_signer_3_result.txid);
        if let Some(ref txid) = add_signer_3_result.txid {
            tx_ids.push(("UpdateKeyPage", txid.clone()));
        }
    } else {
        println!("UpdateKeyPage FAILED: {:?}", add_signer_3_result.error);
    }

    // =========================================================
    // UpdateKeyPage (Action: UpdateKeyPage)
    // =========================================================
    let mut set_threshold_signer = SmartSigner::new(&client, set_threshold_signer.clone(), &set_threshold_lid);
    let set_threshold_result = set_threshold_signer.sign_submit_and_wait(
        "{adi_url}/{key_book_name}/1",
        &TxBody::update_key_page(&json!([{"type":"setThreshold","threshold":"threshold"}])),
        Some("Update key page"),
        30,
    ).await;
    if set_threshold_result.success {
        println!("UpdateKeyPage SUCCESS - TxID: {:?}", set_threshold_result.txid);
        if let Some(ref txid) = set_threshold_result.txid {
            tx_ids.push(("UpdateKeyPage", txid.clone()));
        }
    } else {
        println!("UpdateKeyPage FAILED: {:?}", set_threshold_result.error);
    }

    // =========================================================
    // Transaction Summary
    // =========================================================
    println!("\n========== Transaction Summary ==========");
    for (label, txid) in &tx_ids {
        println!("  {}: {}", label, txid);
    }
    println!("Flow completed successfully!");
    Ok(())
}
