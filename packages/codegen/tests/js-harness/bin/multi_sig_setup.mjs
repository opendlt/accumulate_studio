/**
 * Multi-Signature Setup
 * Generated by Accumulate Studio
 * Network: devnet
 *
 * Install: npm install accumulate.js
 * Run with: node script.mjs
 */

import {
    Accumulate,
    SmartSigner,
    TxBody,
    Ed25519KeyPair,
    KERMIT_V2,
    KERMIT_V3,
} from "accumulate.js";

const V2_ENDPOINT = process.env.ACCUMULATE_V2_URL || KERMIT_V2;
const V3_ENDPOINT = process.env.ACCUMULATE_V3_URL || KERMIT_V3;

async function main() {
    const client = Accumulate.custom(V2_ENDPOINT, V3_ENDPOINT);
    const txIds = [];
    try {


        // =========================================================
        // CreateKeyBook (Action: CreateKeyBook)
        // =========================================================
        const createKeyBookSigner = new SmartSigner(client, createKeyBookKp.toKey(), createKeyBookLid);
        const createKeyBookResult = await createKeyBookSigner.signSubmitAndWait(
            "adi_url",
            TxBody.createKeyBook(
                "{adi_url}/{key_book_name}",
                signer_1_public_key_hash,
            ),
        );
        if (createKeyBookResult.success) {
            console.log(`CreateKeyBook SUCCESS - TxID: ${createKeyBookResult.txid}`);
            if (createKeyBookResult.txid) txIds.push(["CreateKeyBook", createKeyBookResult.txid]);
        } else {
            console.log(`CreateKeyBook FAILED: ${createKeyBookResult.error}`);
        }


        // =========================================================
        // CreateKeyPage (Action: CreateKeyPage)
        // =========================================================
        const createKeyPageSigner = new SmartSigner(client, createKeyPageKp.toKey(), createKeyPageLid);
        const createKeyPageResult = await createKeyPageSigner.signSubmitAndWait(
            "{adi_url}/{key_book_name}",
            TxBody.createKeyPage([
                "signer_1_public_key_hash",
            ]),
        );
        if (createKeyPageResult.success) {
            console.log(`CreateKeyPage SUCCESS - TxID: ${createKeyPageResult.txid}`);
            if (createKeyPageResult.txid) txIds.push(["CreateKeyPage", createKeyPageResult.txid]);
        } else {
            console.log(`CreateKeyPage FAILED: ${createKeyPageResult.error}`);
        }


        // =========================================================
        // UpdateKeyPage (Action: UpdateKeyPage)
        // =========================================================
        const addSigner_2Signer = new SmartSigner(client, addSigner_2Kp.toKey(), addSigner_2Lid);
        const addSigner_2Result = await addSigner_2Signer.signSubmitAndWait(
            "{adi_url}/{key_book_name}/1",
            TxBody.updateKeyPage([{"type":"add","key":"signer_2_public_key_hash"}]),
        );
        if (addSigner_2Result.success) {
            console.log(`UpdateKeyPage SUCCESS - TxID: ${addSigner_2Result.txid}`);
            if (addSigner_2Result.txid) txIds.push(["UpdateKeyPage", addSigner_2Result.txid]);
        } else {
            console.log(`UpdateKeyPage FAILED: ${addSigner_2Result.error}`);
        }


        // =========================================================
        // UpdateKeyPage (Action: UpdateKeyPage)
        // =========================================================
        const addSigner_3Signer = new SmartSigner(client, addSigner_3Kp.toKey(), addSigner_3Lid);
        const addSigner_3Result = await addSigner_3Signer.signSubmitAndWait(
            "{adi_url}/{key_book_name}/1",
            TxBody.updateKeyPage([{"type":"add","key":"signer_3_public_key_hash"}]),
        );
        if (addSigner_3Result.success) {
            console.log(`UpdateKeyPage SUCCESS - TxID: ${addSigner_3Result.txid}`);
            if (addSigner_3Result.txid) txIds.push(["UpdateKeyPage", addSigner_3Result.txid]);
        } else {
            console.log(`UpdateKeyPage FAILED: ${addSigner_3Result.error}`);
        }


        // =========================================================
        // UpdateKeyPage (Action: UpdateKeyPage)
        // =========================================================
        const setThresholdSigner = new SmartSigner(client, setThresholdKp.toKey(), setThresholdLid);
        const setThresholdResult = await setThresholdSigner.signSubmitAndWait(
            "{adi_url}/{key_book_name}/1",
            TxBody.updateKeyPage([{"type":"setThreshold","threshold":"threshold"}]),
        );
        if (setThresholdResult.success) {
            console.log(`UpdateKeyPage SUCCESS - TxID: ${setThresholdResult.txid}`);
            if (setThresholdResult.txid) txIds.push(["UpdateKeyPage", setThresholdResult.txid]);
        } else {
            console.log(`UpdateKeyPage FAILED: ${setThresholdResult.error}`);
        }


        console.log("\n========== Transaction Summary ==========");
        for (const [label, txid] of txIds) {
            console.log(`  ${label}: ${txid}`);
        }
        console.log("Flow completed successfully!");
    } catch (err) {
        console.error("Flow failed:", err);
    }
}

main().catch(console.error);
