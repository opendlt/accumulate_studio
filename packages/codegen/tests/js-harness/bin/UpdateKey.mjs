/**
 * UpdateKey E2E
 * Generated by Accumulate Studio
 * Network: kermit
 *
 * Install: npm install accumulate.js
 * Run with: node script.mjs
 */

import {
    Accumulate,
    SmartSigner,
    TxBody,
    Ed25519KeyPair,
    KERMIT_V2,
    KERMIT_V3,
    pollForBalance,
    pollForCredits,
} from "accumulate.js";

const V2_ENDPOINT = process.env.ACCUMULATE_V2_URL || KERMIT_V2;
const V3_ENDPOINT = process.env.ACCUMULATE_V3_URL || KERMIT_V3;

async function main() {
    const client = Accumulate.custom(V2_ENDPOINT, V3_ENDPOINT);
    const txIds = [];
    try {


        // =========================================================
        // GenerateKeys (GenerateKeys)
        // =========================================================
        const generatekeysKp = Ed25519KeyPair.generate();
        const generatekeysLid = generatekeysKp.deriveLiteIdentityUrl();
        const generatekeysLta = generatekeysKp.deriveLiteTokenAccountUrl();
        const generatekeysPubHash = generatekeysKp.publicKeyHashHex();
        console.log("Generated keypair:");
        console.log(`  Lite Identity: ${generatekeysLid}`);
        console.log(`  Lite Token Account: ${generatekeysLta}`);
        console.log(`  Public Key Hash: ${generatekeysPubHash}`);


        // =========================================================
        // Faucet (Faucet)
        // =========================================================
        console.log("Requesting tokens from faucet...");
        await client.faucet(generatekeysLta, 1, 2000);
        console.log("Faucet request completed");


        // =========================================================
        // WaitForBalance (WaitForBalance)
        // =========================================================
        console.log("Waiting for balance >= 10000000...");
        await pollForBalance(client, generatekeysLta, 10000000);
        console.log("Balance reached");


        // =========================================================
        // AddCredits (Action: AddCredits)
        // =========================================================
        const addcreditsOracle = await client.getOraclePrice();
        const addcreditsSigner = new SmartSigner(client, generatekeysKp.toKey(), generatekeysLid);
        const addcreditsResult = await addcreditsSigner.signSubmitAndWait(
            generatekeysLta,
            TxBody.addCredits(
                generatekeysLid,
                "2000000",
                addcreditsOracle,
            ),
        );
        if (addcreditsResult.success) {
            console.log(`AddCredits SUCCESS - TxID: ${addcreditsResult.txid}`);
            if (addcreditsResult.txid) txIds.push(["AddCredits", addcreditsResult.txid]);
        } else {
            console.log(`AddCredits FAILED: ${addcreditsResult.error}`);
        }


        // =========================================================
        // WaitForCredits (WaitForCredits)
        // =========================================================
        console.log("Waiting for credits >= 100...");
        await pollForCredits(client, generatekeysLid, 100);
        console.log("Credits reached");


        // =========================================================
        // CreateIdentity (Action: CreateIdentity)
        // =========================================================
        const createidentitySigner = new SmartSigner(client, generatekeysKp.toKey(), generatekeysLid);
        const createidentityResult = await createidentitySigner.signSubmitAndWait(
            generatekeysLta,
            TxBody.createIdentity(
                "acc://e2e-a9efd27b.acme",
                "acc://e2e-a9efd27b.acme/book",
                generatekeysPubHash,
            ),
        );
        if (createidentityResult.success) {
            console.log(`CreateIdentity SUCCESS - TxID: ${createidentityResult.txid}`);
            if (createidentityResult.txid) txIds.push(["CreateIdentity", createidentityResult.txid]);
        } else {
            console.log(`CreateIdentity FAILED: ${createidentityResult.error}`);
        }


        // =========================================================
        // AddCredits_2 (Action: AddCredits)
        // =========================================================
        const addcredits_2Oracle = await client.getOraclePrice();
        const addcredits_2Signer = new SmartSigner(client, generatekeysKp.toKey(), generatekeysLid);
        const addcredits_2Result = await addcredits_2Signer.signSubmitAndWait(
            generatekeysLta,
            TxBody.addCredits(
                generatekeysLid,
                "5000000",
                addcredits_2Oracle,
            ),
        );
        if (addcredits_2Result.success) {
            console.log(`AddCredits SUCCESS - TxID: ${addcredits_2Result.txid}`);
            if (addcredits_2Result.txid) txIds.push(["AddCredits", addcredits_2Result.txid]);
        } else {
            console.log(`AddCredits FAILED: ${addcredits_2Result.error}`);
        }


        // =========================================================
        // WaitForCredits_2 (WaitForCredits)
        // =========================================================
        console.log("Waiting for credits >= 100...");
        await pollForCredits(client, generatekeysLid, 100);
        console.log("Credits reached");


        // =========================================================
        // UpdateKey (Action: UpdateKey)
        // =========================================================
        const updatekeySigner = new SmartSigner(client, generatekeysKp.toKey(), generatekeysLid);
        const updatekeyResult = await updatekeySigner.signSubmitAndWait(
            "acc://e2e-a9efd27b.acme/book/1",
            TxBody.updateKey("cafebabecafebabecafebabecafebabe"),
        );
        if (updatekeyResult.success) {
            console.log(`UpdateKey SUCCESS - TxID: ${updatekeyResult.txid}`);
            if (updatekeyResult.txid) txIds.push(["UpdateKey", updatekeyResult.txid]);
        } else {
            console.log(`UpdateKey FAILED: ${updatekeyResult.error}`);
        }


        console.log("\n========== Transaction Summary ==========");
        for (const [label, txid] of txIds) {
            console.log(`  ${label}: ${txid}`);
        }
        console.log("Flow completed successfully!");
    } catch (err) {
        console.error("Flow failed:", err);
    }
}

main().catch(console.error);
