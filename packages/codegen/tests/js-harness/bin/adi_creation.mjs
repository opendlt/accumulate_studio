/**
 * Full ADI Creation
 * Generated by Accumulate Studio
 * Network: devnet
 *
 * Install: npm install accumulate.js
 * Run with: node script.mjs
 */

import {
    Accumulate,
    SmartSigner,
    TxBody,
    Ed25519KeyPair,
    KERMIT_V2,
    KERMIT_V3,
    pollForBalance,
    pollForCredits,
} from "accumulate.js";

const V2_ENDPOINT = process.env.ACCUMULATE_V2_URL || KERMIT_V2;
const V3_ENDPOINT = process.env.ACCUMULATE_V3_URL || KERMIT_V3;

async function main() {
    const client = Accumulate.custom(V2_ENDPOINT, V3_ENDPOINT);
    const txIds = [];
    try {


        // =========================================================
        // GenerateKeys (GenerateKeys)
        // =========================================================
        const generateKeysKp = Ed25519KeyPair.generate();
        const generateKeysLid = generateKeysKp.deriveLiteIdentityUrl();
        const generateKeysLta = generateKeysKp.deriveLiteTokenAccountUrl();
        const generateKeysPubHash = generateKeysKp.publicKeyHashHex();
        console.log("Generated keypair:");
        console.log(`  Lite Identity: ${generateKeysLid}`);
        console.log(`  Lite Token Account: ${generateKeysLta}`);
        console.log(`  Public Key Hash: ${generateKeysPubHash}`);


        // =========================================================
        // Faucet (Faucet)
        // =========================================================
        console.log("Requesting tokens from faucet...");
        await client.faucet(generateKeysLta, 3, 2000);
        console.log("Faucet request completed");


        // =========================================================
        // WaitForBalance (WaitForBalance)
        // =========================================================
        console.log("Waiting for balance >= 15.00000000...");
        await pollForBalance(client, generateKeysLta, 15.00000000);
        console.log("Balance reached");


        // =========================================================
        // AddCredits (Action: AddCredits)
        // =========================================================
        const addCreditsOracle = await client.getOraclePrice();
        const addCreditsSigner = new SmartSigner(client, generateKeysKp.toKey(), generateKeysLid);
        const addCreditsResult = await addCreditsSigner.signSubmitAndWait(
            generateKeysLta,
            TxBody.addCredits(
                generateKeysLid,
                "1000000000",
                addCreditsOracle,
            ),
        );
        if (addCreditsResult.success) {
            console.log(`AddCredits SUCCESS - TxID: ${addCreditsResult.txid}`);
            if (addCreditsResult.txid) txIds.push(["AddCredits", addCreditsResult.txid]);
        } else {
            console.log(`AddCredits FAILED: ${addCreditsResult.error}`);
        }


        // =========================================================
        // CreateIdentity (Action: CreateIdentity)
        // =========================================================
        const createIdentitySigner = new SmartSigner(client, generateKeysKp.toKey(), generateKeysLid);
        const createIdentityResult = await createIdentitySigner.signSubmitAndWait(
            generateKeysLid,
            TxBody.createIdentity(
                "acc://{adi_name}.acme",
                "acc://{adi_name}.acme/book",
                generateKeysPubHash,
            ),
        );
        if (createIdentityResult.success) {
            console.log(`CreateIdentity SUCCESS - TxID: ${createIdentityResult.txid}`);
            if (createIdentityResult.txid) txIds.push(["CreateIdentity", createIdentityResult.txid]);
        } else {
            console.log(`CreateIdentity FAILED: ${createIdentityResult.error}`);
        }


        // =========================================================
        // CreateKeyBook (Action: CreateKeyBook)
        // =========================================================
        const createKeyBookSigner = new SmartSigner(client, generateKeysKp.toKey(), generateKeysLid);
        const createKeyBookResult = await createKeyBookSigner.signSubmitAndWait(
            "acc://{adi_name}.acme",
            TxBody.createKeyBook(
                "acc://{adi_name}.acme/admin-book",
                generateKeysPubHash,
            ),
        );
        if (createKeyBookResult.success) {
            console.log(`CreateKeyBook SUCCESS - TxID: ${createKeyBookResult.txid}`);
            if (createKeyBookResult.txid) txIds.push(["CreateKeyBook", createKeyBookResult.txid]);
        } else {
            console.log(`CreateKeyBook FAILED: ${createKeyBookResult.error}`);
        }


        // =========================================================
        // CreateKeyPage (Action: CreateKeyPage)
        // =========================================================
        const createKeyPageSigner = new SmartSigner(client, generateKeysKp.toKey(), generateKeysLid);
        const createKeyPageResult = await createKeyPageSigner.signSubmitAndWait(
            "acc://{adi_name}.acme/admin-book",
            TxBody.createKeyPage([
                "generateKeysPubHash",
            ]),
        );
        if (createKeyPageResult.success) {
            console.log(`CreateKeyPage SUCCESS - TxID: ${createKeyPageResult.txid}`);
            if (createKeyPageResult.txid) txIds.push(["CreateKeyPage", createKeyPageResult.txid]);
        } else {
            console.log(`CreateKeyPage FAILED: ${createKeyPageResult.error}`);
        }


        console.log("\n========== Transaction Summary ==========");
        for (const [label, txid] of txIds) {
            console.log(`  ${label}: ${txid}`);
        }
        console.log("Flow completed successfully!");
    } catch (err) {
        console.error("Flow failed:", err);
    }
}

main().catch(console.error);
